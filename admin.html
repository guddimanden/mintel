<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>IntelBreach Admin Panel</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
<style>
html, body {
  margin: 0; padding: 0; height: 100%;
  font-family: 'Inter', sans-serif;
  background: #0a0a0a;
  color: #f0f0f5;
  overflow-x: hidden;
}
canvas#bgCanvas {
  position: fixed; top:0; left:0;
  width:100%; height:100%;
  z-index:-1;
}
.panel {
  max-width: 1000px;
  margin: 60px auto;
  padding: 28px;
  border-radius: 16px;
  background: rgba(20,20,20,0.9);
  border: 1px solid rgba(255,255,255,0.05);
  box-shadow: 0 4px 40px rgba(0,0,0,0.2);
  backdrop-filter: blur(8px);
}
h2 {
  color: #ff4c8b;
  text-align: center;
  font-size: 2.3rem;
  margin-bottom: 30px;
  letter-spacing: 1px;
}

/* LOGIN */
#loginSection { text-align:center; }
#loginSection input {
  padding: 12px; margin: 8px 0;
  width: 80%; border-radius: 10px;
  border: 1px solid rgba(255,255,255,0.1);
  background: #121212; color: #fff; font-size:1rem;
  transition:0.2s;
}
#loginSection input:focus {
  border-color: #ff4c8b; outline:none; background:#151515;
}
#loginSection button {
  margin-top:12px; padding:12px 20px;
  border-radius:12px; border:none;
  background: linear-gradient(90deg,#ff4c8b,#ff6b9f);
  color:#fff; font-weight:700; cursor:pointer; transition:0.2s;
}
#loginSection button:hover { transform: translateY(-2px); box-shadow:0 0 12px rgba(255,76,139,0.4); }
#loginMsg { margin-top:10px; color:#ffb0c9; }

/* ADMIN */
#adminSection { display:none; animation: fadeIn 0.5s ease; }
@keyframes fadeIn { from {opacity:0; transform:translateY(10px);} to {opacity:1; transform:translateY(0);} }

#logoutBtn {
  margin-bottom:20px; padding:10px 16px;
  border-radius:10px; border:none;
  background: linear-gradient(90deg,#ff4c8b,#ff6b9f);
  color:#fff; font-weight:700; cursor:pointer; transition:0.2s;
}
#logoutBtn:hover { transform:translateY(-2px); box-shadow:0 0 10px rgba(255,76,139,0.4); }

#uploadForm { display:flex; flex-direction:column; gap:12px; margin-bottom:24px; }
select, input[type="file"] {
  padding:10px; border-radius:10px; border:1px solid rgba(255,255,255,0.1);
  background:#121212; color:#fff; font-size:1rem; transition:0.2s;
}
select:hover, input[type="file"]:hover { border-color:#ff4c8b; }
#uploadForm button {
  padding:12px; border-radius:12px; border:none;
  background: linear-gradient(90deg,#ff4c8b,#ff6b9f);
  color:#fff; font-weight:700; cursor:pointer; transition:0.2s;
}
#uploadForm button:hover { transform:translateY(-2px); box-shadow:0 0 10px rgba(255,76,139,0.4); }

#msg { margin-top:10px; color:#ffb0c9; font-weight:600; }

#filePreview { border-top:1px dashed rgba(255,255,255,0.1); padding-top:12px; max-height:500px; overflow-y:auto; }
.file-row {
  display:flex; justify-content:space-between; align-items:center;
  padding:10px 8px; margin:5px 0; border-radius:8px;
  transition:0.2s;
}
.file-row:hover { background:rgba(255,76,139,0.07); transform:scale(1.01); }
.file-name { flex:1; cursor:pointer; }
.file-name:hover { color:#ff4c8b; }
.file-actions {
  display:flex; align-items:center; opacity:0; transition:0.2s;
}
.file-row:hover .file-actions { opacity:1; }
.file-actions a {
  text-decoration:none; font-weight:600; padding:6px 12px; border-radius:8px;
  cursor:pointer; margin-left:8px; transition:0.2s;
}
.file-actions a.download { background: linear-gradient(90deg,#ff4c8b,#ff6b9f); color:#fff; }
.file-actions a.download:hover { transform:translateY(-2px); }
.file-actions a.delete { background:#2b0b12; color:#ff4c8b; }
.file-actions a.delete:hover { transform:translateY(-2px); }
</style>
</head>
<body>

<canvas id="bgCanvas"></canvas>

<div class="panel">
  <h2>IntelBreach Admin Panel</h2>

  <div id="loginSection">
    <p>Log in to access admin features:</p>
    <form id="loginForm">
      <input type="text" name="username" placeholder="Username" required>
      <input type="password" name="password" placeholder="Password" required>
      <button type="submit">Login</button>
    </form>
    <div id="loginMsg"></div>
  </div>

  <div id="adminSection">
    <button id="logoutBtn">Logout</button>

    <form id="uploadForm">
      <label>Upload to:
        <select id="uploadTarget"></select>
      </label>
      <input id="fileInput" type="file" webkitdirectory directory multiple>
      <button type="submit">Upload Files</button>
    </form>

    <div id="msg"></div>

    <h3>Files & Folders:</h3>
    <div id="filePreview"></div>
  </div>
</div>

<script>
const loginForm = document.getElementById('loginForm');
const loginSection = document.getElementById('loginSection');
const adminSection = document.getElementById('adminSection');
const uploadTarget = document.getElementById('uploadTarget');
const fileInput = document.getElementById('fileInput');
const msgEl = document.getElementById('msg');
const filePreview = document.getElementById('filePreview');

async function loadUploadTargets() {
  uploadTarget.innerHTML = '';
  const res = await fetch('/api/list?dir=/', {credentials:'include'});
  if(!res.ok) return;
  const data = await res.json();

  function addOptions(items, prefix=''){
    items.forEach(item=>{
      if(item.type==='DIR'){
        const opt = document.createElement('option');
        opt.value = item.path;
        opt.textContent = prefix + item.name;
        uploadTarget.appendChild(opt);
        if(item.items) addOptions(item.items, prefix + item.name + '/');
      }
    });
  }

  addOptions(data.items);
}

async function loadFiles(){
  filePreview.innerHTML='';
  const res = await fetch('/api/list?dir=/', {credentials:'include'});
  if(!res.ok) return;
  const data = await res.json();

  function addFiles(items, container, depth=0){
    items.forEach(f=>{
      const row = document.createElement('div');
      row.className = 'file-row';
      row.style.paddingLeft = `${depth*20}px`;

      const nameSpan = document.createElement('span');
      nameSpan.className = 'file-name';
      if(f.type==='DIR') nameSpan.textContent = '▶ ' + f.name;
      else nameSpan.textContent = f.name;

      if(f.type==='DIR'){
        nameSpan.onclick = () => {
          const next = row.nextSibling;
          if(next && next.classList && next.classList.contains('nested')){
            next.remove();
            nameSpan.textContent = '▶ ' + f.name;
          } else {
            const nested = document.createElement('div');
            nested.className = 'nested';
            addFiles(f.items,nested,depth+1);
            row.after(nested);
            nameSpan.textContent = '▼ ' + f.name;
          }
        };
      }

      const actions = document.createElement('span');
      actions.className = 'file-actions';

      const downloadA = document.createElement('a');
      downloadA.className='download';
      downloadA.textContent='Download';
      downloadA.onclick=e=>{
        e.preventDefault();
        const link=document.createElement('a');
        if(f.type==='DIR'){
          link.href=`/api/download?dir=${encodeURIComponent(f.path)}`;
          link.download=f.name+'.zip';
        } else {
          link.href=`/api/view${f.path}`;
          link.download=f.name;
        }
        link.click();
      };

      const deleteA = document.createElement('a');
      deleteA.className='delete';
      deleteA.textContent='Delete';
      deleteA.onclick=async e=>{
        e.preventDefault();
        if(!confirm('Delete this item?')) return;
        await fetch('/api/delete',{
          method:'POST',
          body:JSON.stringify({path:f.path}),
          headers:{'Content-Type':'application/json'},
          credentials:'include'
        });
        loadFiles(); loadUploadTargets();
      };

      actions.appendChild(downloadA);
      actions.appendChild(deleteA);
      row.appendChild(nameSpan);
      row.appendChild(actions);
      container.appendChild(row);
    });
  }

  addFiles(data.items, filePreview);
}

// LOGIN FIXED
loginForm.addEventListener('submit', async e => {
  e.preventDefault();
  const fd = new FormData(loginForm);
  const data = {
    username: fd.get('username'),
    password: fd.get('password')
  };

  const res = await fetch('/api/login', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(data),
    credentials: 'include'
  });

  const json = await res.json();
  if(json.ok){
    loginSection.style.display='none';
    adminSection.style.display='block';
    loadFiles();
    loadUploadTargets();
  } else {
    document.getElementById('loginMsg').textContent = 'Login failed';
  }
});

// LOGOUT
document.getElementById('logoutBtn').addEventListener('click', async () => {
  await fetch('/api/logout', {method:'POST', credentials:'include'});
  location.reload();
});

// UPLOAD
document.getElementById('uploadForm').addEventListener('submit', async e=>{
  e.preventDefault();
  const files = fileInput.files;
  if(!files.length){ msgEl.textContent='No files selected'; return; }
  msgEl.textContent='Uploading...';
  const targetDir = uploadTarget.value;

  for(const f of files){
    const fd = new FormData();
    fd.append('category', targetDir);
    fd.append('filepath', f.webkitRelativePath || f.name);
    fd.append('file', f, f.name);
    await fetch('/api/upload', {method:'POST', body:fd, credentials:'include'});
  }

  msgEl.textContent='Upload complete!';
  fileInput.value='';
  loadFiles(); loadUploadTargets();
});

// INITIAL LOAD
window.addEventListener('DOMContentLoaded', () => {
  loadUploadTargets();
});

// BACKGROUND PARTICLES
const canvas = document.getElementById('bgCanvas');
const ctx = canvas.getContext('2d');
let w = canvas.width = window.innerWidth;
let h = canvas.height = window.innerHeight;
window.addEventListener('resize', ()=>{ w=canvas.width=window.innerWidth; h=canvas.height=window.innerHeight; });

const particles=[]; for(let i=0;i<120;i++) particles.push({x:Math.random()*w,y:Math.random()*h,vx:(Math.random()-0.5)*0.5,vy:(Math.random()-0.5)*0.5,size:Math.random()*2+1});

function anim(){
  ctx.clearRect(0,0,w,h);
  ctx.fillStyle='rgba(255,76,139,0.5)';
  particles.forEach(p=>{
    ctx.beginPath();
    ctx.arc(p.x,p.y,p.size,0,Math.PI*2);
    ctx.fill();
    p.x+=p.vx; p.y+=p.vy;
    if(p.x<0||p.x>w)p.vx*=-1;
    if(p.y<0||p.y>h)p.vy*=-1;
  });
  requestAnimationFrame(anim);
}
anim();
</script>
</body>
</html>
