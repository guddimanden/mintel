<?php
require_once 'includes/config.php';

if (!isset($_SESSION['user_id'])) {
    header("Location: login.php");
    exit();
}

if (!isset($_GET['id'])) {
    header("Location: index.php");
    exit();
}

$post_id = $_GET['id'];
$stmt = $conn->prepare("
    SELECT p.*, u.username, u.role 
    FROM posts p 
    JOIN users u ON p.user_id = u.id 
    WHERE p.id = ?
");
$stmt->bind_param("i", $post_id);
$stmt->execute();
$post = $stmt->get_result()->fetch_assoc();

if (!$post) {
    header("Location: index.php");
    exit();
}
?>
<!DOCTYPE html>
<html>
<head>
    <title><?= htmlspecialchars($post['title']) ?> | IntelBreach</title>
    <link rel="stylesheet" href="assets/css/style.css">
</head>
<body>
    <header>
        <div class="logo">IntelBreach</div>
        <nav>
            <a href="index.php">Home</a>
            <a href="leaks.php">Leaks</a>
            <a href="marketplace.php">Marketplace</a>
            <a href="profile.php">Profile</a>
            <a href="logout.php">Logout</a>
        </nav>
    </header>

    <div class="container">
        <div class="sidebar">
            <h3>Categories</h3>
            <ul>
                <li><a href="leaks.php">Databases</a></li>
                <li><a href="leaks.php?type=stealer">Stealer Logs</a></li>
                <li><a href="leaks.php?type=other">Other Leaks</a></li>
            </ul>
        </div>

        <div class="main-content">
            <div class="post">
                <div class="post-header">
                    <span class="user-role <?= $post['role'] ?>"><?= strtoupper($post['role']) ?></span>
                    <span class="username"><?= htmlspecialchars($post['username']) ?></span>
                    <span class="post-date"><?= date('M d, Y', strtotime($post['created_at'])) ?></span>
                </div>
                <h2><?= htmlspecialchars($post['title']) ?></h2>
                <p><?= nl2br(htmlspecialchars($post['content'])) ?></p>
                <div class="post-footer">
                    <span class="category"><?= ucfirst($post['category']) ?></span>
                </div>
            </div>

            <div class="comments">
                <h3>Comments</h3>
                <div class="comment-form">
                    <form action="add_comment.php" method="POST">
                        <input type="hidden" name="post_id" value="<?= $post['id'] ?>">
                        <textarea name="content" placeholder="Add a comment..." required></textarea>
                        <button type="submit">Post Comment</button>
                    </form>
                </div>
            </div>
        </div>
    </div>
</body>
</html>